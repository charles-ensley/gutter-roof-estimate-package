<template>
    <lightning-card title="Google Street View" icon-name="custom:custom59">
        <!-- API Key Warning -->
        <template if:true={showApiKeyWarning}>
            <div class="slds-m-around_medium">
                <div class="slds-notify slds-notify_alert slds-alert_warning" role="alert">
                    <span class="slds-assistive-text">Warning</span>
                    <h2>
                        <lightning-icon 
                            icon-name="utility:warning" 
                            alternative-text="Warning" 
                            size="x-small" 
                            class="slds-m-right_x-small">
                        </lightning-icon>
                        <strong>Google Maps API Key Required</strong>
                    </h2>
                    <div class="slds-m-top_x-small">
                        <p class="slds-text-body_small">
                            To display Street View, you need to configure a Google Maps API Key in the component settings.
                            Edit this page in Lightning App Builder and add your API key to the component properties.
                        </p>
                        <p class="slds-text-body_small slds-m-top_small">
                            <a href="https://developers.google.com/maps/documentation/javascript/get-api-key" 
                               target="_blank" 
                               class="slds-text-link">
                                Get a Google Maps API Key →
                            </a>
                        </p>
                    </div>
                </div>
            </div>
        </template>

        <!-- Error Display -->
        <template if:true={error}>
            <template if:false={showApiKeyWarning}>
                <div class="slds-m-around_medium">
                    <div class="slds-text-color_error">
                        <lightning-icon 
                            icon-name="utility:error" 
                            alternative-text="Error" 
                            size="small" 
                            class="slds-m-right_x-small">
                        </lightning-icon>
                        {error.message}
                    </div>
                </div>
            </template>
        </template>

        <!-- Loading State -->
        <template if:true={isLoading}>
            <template if:false={error}>
                <template if:false={showApiKeyWarning}>
                    <div class="slds-m-around_medium">
                        <lightning-spinner 
                            alternative-text="Loading Street View" 
                            size="medium">
                        </lightning-spinner>
                    </div>
                </template>
            </template>
        </template>

        <!-- Main Content -->
        <template if:true={contactData}>
            <template if:false={showApiKeyWarning}>
                <template if:false={error}>
                    <template if:true={hasAddress}>
                        <!-- Address Header -->
                        <div class="slds-m-around_medium">
                            <div class="slds-media slds-media_center">
                                <div class="slds-media__figure">
                                    <lightning-icon 
                                        icon-name="utility:street_view" 
                                        alternative-text="Street View" 
                                        size="medium">
                                    </lightning-icon>
                                </div>
                                <div class="slds-media__body">
                                    <h3 class="slds-text-heading_small slds-m-bottom_x-small">
                                        Street View: {contactName}
                                    </h3>
                                    <p class="slds-text-body_small slds-text-color_weak">
                                        {fullAddress}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Street View Image -->
                        <template if:true={hasCoordinates}>
                            <template if:true={streetViewImageUrl}>
                                <div class="street-view-image-container" onclick={handleImageClick}>
                                    <img 
                                        src={streetViewImageUrl}
                                        alt="Street View"
                                        style={imageStyle}
                                        onerror={handleImageError}
                                        title="Click to open in Google Maps"
                                    />
                                    <div class="image-overlay">
                                        <lightning-icon 
                                            icon-name="utility:new_window" 
                                            alternative-text="Open" 
                                            size="small"
                                            class="overlay-icon">
                                        </lightning-icon>
                                        <span class="overlay-text">Click to explore in Google Maps</span>
                                    </div>
                                </div>
                            </template>

                            <!-- Interactive Controls -->
                            <div class="slds-m-around_medium">
                                <div class="slds-grid slds-grid_vertical-align-center slds-m-bottom_small">
                                    <lightning-button 
                                        label={controlsButtonLabel}
                                        onclick={toggleControls}
                                        variant="neutral"
                                        icon-name="utility:settings"
                                        class="slds-m-right_x-small">
                                    </lightning-button>
                                    
                                    <lightning-button 
                                        label="Open Interactive Street View" 
                                        onclick={handleOpenInGoogleMaps}
                                        variant="brand"
                                        icon-name="utility:new_window">
                                    </lightning-button>
                                </div>

                                <!-- Slider Controls (Collapsible) -->
                                <template if:true={showControls}>
                                    <div class="slds-box slds-theme_shade slds-m-top_small">
                                        <h3 class="slds-text-heading_small slds-m-bottom_small">
                                            Adjust View Direction
                                        </h3>
                                        
                                        <!-- Heading Slider -->
                                        <div class="slds-m-bottom_medium">
                                            <label class="slds-form-element__label slds-m-bottom_xx-small">
                                                Camera Heading: {currentHeading}° ({directionLabel})
                                            </label>
                                            <input 
                                                type="range" 
                                                min="0" 
                                                max="360" 
                                                value={sliderValue}
                                                onchange={handleHeadingChange}
                                                class="slds-slider"
                                            />
                                            <div class="slds-grid slds-grid_align-spread slds-text-body_small slds-text-color_weak slds-m-top_xx-small">
                                                <span>Pan Left (West)</span>
                                                <span>Current Direction</span>
                                                <span>Pan Right (East)</span>
                                            </div>
                                        </div>

                                        <!-- Pitch Slider -->
                                        <div class="slds-m-bottom_medium">
                                            <label class="slds-form-element__label slds-m-bottom_xx-small">
                                                Camera Pitch: {currentPitch}° 
                                                <template if:true={currentPitch}>
                                                    <template if:false={currentPitch}>
                                                        (Straight)
                                                    </template>
                                                </template>
                                            </label>
                                            <input 
                                                type="range" 
                                                min="-90" 
                                                max="90" 
                                                value={currentPitch}
                                                onchange={handlePitchChange}
                                                class="slds-slider"
                                            />
                                            <div class="slds-grid slds-grid_align-spread slds-text-body_small slds-text-color_weak slds-m-top_xx-small">
                                                <span>-90° (Down)</span>
                                                <span>0° (Straight)</span>
                                                <span>90° (Up)</span>
                                            </div>
                                        </div>

                                        <!-- Field of View Slider -->
                                        <div class="slds-m-bottom_small">
                                            <label class="slds-form-element__label slds-m-bottom_xx-small">
                                                Field of View: {currentFov}° (Zoom)
                                            </label>
                                            <input 
                                                type="range" 
                                                min="10" 
                                                max="120" 
                                                value={currentFov}
                                                onchange={handleFovChange}
                                                class="slds-slider"
                                            />
                                            <div class="slds-grid slds-grid_align-spread slds-text-body_small slds-text-color_weak slds-m-top_xx-small">
                                                <span>10° (Zoomed In)</span>
                                                <span>90° (Normal)</span>
                                                <span>120° (Wide)</span>
                                            </div>
                                        </div>

                                        <!-- Action Buttons -->
                                        <div class="slds-grid slds-grid_align-spread slds-m-top_medium">
                                            <lightning-button 
                                                label="Apply Changes" 
                                                onclick={applyChanges}
                                                variant="brand">
                                            </lightning-button>
                                            <lightning-button 
                                                label="Reset to Defaults" 
                                                onclick={resetToDefaults}
                                                variant="neutral">
                                            </lightning-button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>

                    </template>

                    <!-- No Address Available -->
                    <template if:false={hasAddress}>
                        <div class="slds-m-around_medium">
                            <div class="slds-text-align_center">
                                <lightning-icon 
                                    icon-name="utility:location" 
                                    alternative-text="No Address" 
                                    size="medium" 
                                    class="slds-m-bottom_small">
                                </lightning-icon>
                                <p class="slds-text-body_regular">
                                    No address information available for {contactName}.
                                </p>
                            </div>
                        </div>
                    </template>
                </template>
            </template>
        </template>
    </lightning-card>
</template>
